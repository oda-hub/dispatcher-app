# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Test plugins

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "*" ]
    types:
    - labeled
    - opened
    - synchronize
    - reopened


jobs:
  build:
    if: contains( github.event.pull_request.labels.*.name, 'test-plugins')

    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        plugin-name:
        - integral
        - integral-all-sky
        - nb2workflow
        # - antares
        # - gw
        # - legacysurvey
        # - polar

    # services:
    #   antares-backend:
    #     image: odahub/antares:5ed199f
    #     ports: 
    #     - 5002:8000

    steps:
    - uses: actions/checkout@v4
    
    - name: Install uv and set the python version
      uses: astral-sh/setup-uv@v6
      with:
        version: "0.8.13"
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        uv sync --locked --group plugin-${{matrix.plugin-name}}
        curl -o tests/oda-ontology.ttl https://raw.githubusercontent.com/oda-hub/ontology/main/ontology.ttl
    
    - name: Clone ${{ matrix.plugin-name }} plugin 
      uses: actions/checkout@v4
      with:
        repository: 'oda-hub/dispatcher-plugin-${{matrix.plugin-name}}'
        path: dispatcher-plugin-${{matrix.plugin-name}}

    - name: Test ${{ matrix.plugin-name }} plugin with pytest
      env: 
        ODA_ONTOLOGY_PATH: ./tests/oda-ontology.ttl
        DISPATCHER_MOCK_KB: yes
      run: |
        source .venv/bin/activate
        cd dispatcher-plugin-${{matrix.plugin-name}}
        python -m pytest tests -sv --full-trace --log-cli-level=DEBUG 
    
